# PROTEUS configuration file

# This is a comprehensive outline of all configuration options. It includes variables
# which have default values, in order to showcase the range of potential options available.
# Variable defaults are defined in `src/proteus/config/*.py`

# Root tables should be physical, with the exception of "params"
# Software related options should go within the appropriate physical table
# For configuration see https://fwl-proteus.readthedocs.io/en/latest/config.html

# ----------------------------------------------------

# The general structure is:
#   [params]        parameters for code execution, output files, time-stepping, convergence
#   [star]          stellar parameters, model selection
#   [orbit]         planetary orbital parameters
#   [struct]        planetary structure (mass, radius)
#   [atmos_clim]    atmosphere climate parameters, model selection
#   [atmos_chem]    atmosphere chemistry parameters, model selection
#   [escape]        escape parameters, model selection
#   [interior]      magma ocean model selection and parameters
#   [outgas]        outgassing parameters (fO2) and included volatiles
#   [delivery]      initial volatile inventory, and delivery model selection
#   [observe]       synthetic observations

# ----------------------------------------------------

version = "2.0"

# Parameters
[params]
    # output files
    [params.out]
        path        = "all_options"
        logging     = "INFO"
        plot_mod    = 3      # Plotting frequency, 0: wait until completion | n: every n iterations | none: do not plot
        plot_fmt    = "png"  # Plotting image file format, "png" or "pdf" recommended
        write_mod   = 1      # Write CSV frequency, 0: wait until completion | n: every n iterations
        archive_mod = 5      # Archive frequency, 0: wait until completion | n: every n iterations | none: do not archive
        remove_sf = false    # Remove SOCRATES spectral file when simulation ends.

    # time-stepping
    [params.dt]
        minimum      = 1e4    # absolute minimum time-step [years]
        minimum_rel  = 1e-5   # relative minimum time-step [dimensionless]
        maximum      = 1e7    # maximum time-step [yr]
        initial      = 3e1    # inital step size [yr]
        starspec     = 1e9    # interval to re-calculate the stellar spectrum [yr]
        starinst     = 1e1    # interval to re-calculate the instellation [yr]
        method       = "adaptive"  # proportional | adaptive | maximum

        [params.dt.proportional]
            propconst    = 52.0   # Proportionality constant

        [params.dt.adaptive]
            atol         = 0.02   # Step size atol
            rtol         = 0.10   # Step size rtol

    # Termination criteria
    #     Set enabled=true/false in each section to enable/disable that termination criterion
    [params.stop]

        # Require criteria to be satisfied twice before model will exit?
        strict = false

        # required number of iterations
        [params.stop.iters]
            enabled = true
            minimum = 5
            maximum = 9000

        # required time constraints
        [params.stop.time]
            enabled = true
            minimum = 1.0e3      # model will certainly run to t > minimum [yr]
            maximum = 4.567e+9   # model will terminate when t > maximum [yr]

        # solidification
        [params.stop.solid]
            enabled  = true
            phi_crit = 0.01      # non-dim., model will terminate when global melt fraction < phi_crit

        # radiative equilibrium
        [params.stop.radeqm]
            enabled = true
            atol    = 0.2        # absolute tolerance [W m-2]
            rtol    = 1e-3       # relative tolerance

        [params.stop.escape]
            enabled = true
            p_stop  = 5.0        # Stop surface pressure is less than this value

        # disintegration
        [params.stop.disint]
            enabled   = false

            roche_enabled = true
            offset_roche  = 0 # correction to calculated Roche limit [m]

            spin_enabled  = true
            offset_spin   = 0 # correction to calculated Breakup period [s]


# ----------------------------------------------------
# Star
[star]

    # Physical parameters
    mass    = 1.0       # stellar mass [M_sun]
    age_ini = 0.100     # model initialisation age [Gyr]

    module  = "mors"

    [star.mors]
        rot_pcntle  = 50.0      # rotation percentile
        rot_period  = "none"    # rotation period [days]
        tracks      = "spada"   # evolution tracks: spada | baraffe
        age_now     = 4.567     # current age of star [Gyr]
        spec        = "stellar_spectra/Named/sun.txt" # path to stellar spectrum file

    [star.dummy]
        radius           = 1.0      # Constant stellar radius [R_sun]
        calculate_radius = false    # Calculate star radius using scaling from Teff?
        Teff             = 5772.0   # Star's brightness temperature [K]

# Orbital system
[orbit]
    instellation_method = 'sma' # whether to define orbit using semi major axis ('sma') or instellation flux ('inst')
    instellationflux = 1.0      # instellation flux received from the planet in [Earth units]
    semimajoraxis = 1.0         # initial semi-major axis of planet's orbit [AU]
    eccentricity = 0.0          # initial eccentricity of planet's orbit [dimensionless]
    zenith_angle = 48.19        # characteristic zenith angle [degrees]
    s0_factor = 0.375           # instellation scale factor [dimensionless]

    evolve  = false             # whether to evolve the SMaxis and eccentricity
    module  = "lovepy"          # module used to calculate tidal heating

    axial_period = "none"       # planet's initial day length [hours]; will use orbital period if 'none'
    satellite = false           # include satellite (moon)?
    mass_sat = 7.347e+22        # mass of satellite [kg]
    semimajoraxis_sat = 3e8     # initial SMA of satellite's orbit [m]

    [orbit.dummy]
        H_tide  = 1e-7      # Fixed tidal power density [W kg-1]
        Phi_tide = "<0.3"   # Tidal heating applied when inequality locally satisfied
        Imk2    = 0.0       # Fixed imaginary part of k2 love number, cannot be positive

    [orbit.lovepy]
        visc_thresh = 1e9   # Minimum viscosity required for heating [Pa s]

# Planetary structure - physics table
[struct]
    mass_tot     = 1.0          # M_earth
    radius_int   = "none"       # R_earth
    corefrac     = 0.55         # non-dim., radius fraction
    core_density = 10738.33     # Core density [kg m-3]
    core_heatcap = 880.0        # Core specific heat capacity [J K-1 kg-1]

    module       = "self"       # self | zalmoxis

    [struct.zalmoxis]
        EOSchoice                  = "Tabulated:iron/Tdep_silicate" # EOS choices: "Tabulated:iron/silicate", "Tabulated:iron/Tdep_silicate", "Tabulated:water"
        coremassfrac               = 0.325                          # core mass fraction [non-dim.]
        mantle_mass_fraction       = 0                              # mantle mass fraction [non-dim.]
        weight_iron_frac           = 0.325                          # iron fraction in the planet [non-dim.]
        temperature_mode           = "linear"                   # Input temperature profile choices: "isothermal", "linear", "prescribed"
        surface_temperature        = 3500                           # Surface temperature [K], required for temperature_mode="isothermal" or "linear"
        center_temperature         = 6000                           # Center temperature [K], required for temperature_mode="linear"
        temperature_profile_file   = "zalmoxis_ini_input_temp.txt"  # filename with a prescribed temperature profile, required for temperature_mode="prescribed"
        num_levels                 = 150                            # number of Zalmoxis radius layers
        max_iterations_outer       = 100                            # max. iterations for the outer loop
        tolerance_outer            = 3e-3                           # tolerance for the outer loop
        max_iterations_inner       = 100                            # max. iterations for the inner loop
        tolerance_inner            = 1e-4                           # tolerance for the inner loop
        relative_tolerance         = 1e-5                           # relative tolerance for solve_ivp
        absolute_tolerance         = 1e-6                           # absolute tolerance for solve_ivp
        maximum_step               = 250000                         # maximum integration step size [m]
        adaptive_radial_fraction   = 0.98                           # radial fraction for transition from adaptive integration to fixed-step integration when using "Tabulated:iron/Tdep_silicate" EOS
        max_center_pressure_guess  = 0.99e12                        # maximum central pressure guess based on "Tabulated:iron/Tdep_silicate" EOS limit [Pa]
        target_surface_pressure    = 101325                         # target surface pressure [Pa]
        pressure_tolerance         = 1e9                            # tolerance surface pressure [Pa]
        max_iterations_pressure    = 200                            # max. iterations for the innermost loop
        pressure_adjustment_factor = 1.1                            # factor for adjusting the pressure in the innermost loop
        verbose                    = false                          # detailed convergence info and warnings printing?
        iteration_profiles_enabled = false                          # pressure and density profiles for each iteration logging?

# Atmosphere - physics table
[atmos_clim]
    prevent_warming = true      # do not allow the planet to heat up
    surface_d       = 0.01      # m, conductive skin thickness
    surface_k       = 2.0       # W m-1 K-1, conductive skin thermal conductivity
    cloud_enabled   = false     # enable water cloud radiative effects
    cloud_alpha     = 0.0       # condensate retention fraction (1 -> fully retained)
    surf_state      = "fixed"   # surface scheme: "mixed_layer" | "fixed" | "skin"
    surf_greyalbedo = 0.1       # surface grey albedo
    albedo_pl       = 0.0   	# Enforced input value of bond albedo; float (0 to 1) or str (path to CSV)
    rayleigh        = true     # enable rayleigh scattering
    tmp_minimum     = 0.5       # temperature floor on solver
    tmp_maximum     = 5000.0    # temperature ceiling on solver

    module  = "agni"            # Which atmosphere module to use

    [atmos_clim.agni]
        verbosity       = 1             # output verbosity for agni (0:none, 1:info, 2:debug)
        p_top           = 1.0e-5        # bar, top of atmosphere grid pressure
        p_obs           = 0.02          # bar, level probed in transmission
        spectral_group  = "Honeyside"   # which gas opacities to include
        spectral_bands  = "48"          # how many spectral bands?
        num_levels      = 40            # Number of atmospheric grid levels
        chemistry       = "none"        # "none" | "eq"
        surf_material   = "greybody"    # surface material file for scattering
        solve_energy    = true          # solve for energy-conserving atmosphere profile
        solution_atol   = 0.5           # solver absolute tolerance
        solution_rtol   = 0.15          # solver relative tolerance
        overlap_method  = "ee"          # gas overlap method
        surf_roughness  = 1e-3          # characteristic surface roughness [m]
        surf_windspeed  = 2.0           # characteristic surface wind speed [m/s].
        rainout         = true          # include volatile condensation/evaporation aloft
        latent_heat     = false         # include latent heat release when `rainout=true`?
        oceans          = true          # form liquid oceans at planet surface?
        convection      = true          # include convective heat transport, with MLT
        conduction      = true          # include conductive heat transport, with Fourier's law
        sens_heat       = true          # include sensible heat flux near surface, with TKE scheme
        real_gas        = false         # use real-gas equations of state
        psurf_thresh    = 0.1           # bar, surface pressure where we switch to 'transparent' mode
        dx_max_ini      = 300.0         # initial maximum temperature step [kelvin] allowed by solver
        dx_max          = 35.0          # maximum temperature step [kelvin] allowed by solver
        max_steps       = 70            # max steps allowed by solver during each iteration
        perturb_all     = true          # updated entire jacobian each step?
        mlt_criterion   = "s"           # MLT convection stability criterion; (l)edoux or (s)chwarzschild
        fastchem_floor        = 150.0   # Minimum temperature allowed to be sent to FC
        fastchem_maxiter_chem = 60000   # Maximum FC iterations (chemistry)
        fastchem_maxiter_solv = 20000   # Maximum FC iterations (internal solver)
        fastchem_xtol_chem    = 1e-4    # FC solver tolerance (chemistry)
        fastchem_xtol_elem    = 1e-4    # FC solver tolerance (elemental)
        ini_profile     = 'isothermal'  # Initial guess for temperature profile shape
        ls_default      = 2             # Default linesearch method (0:none, 1:gs, 2:bt)
        fdo             = 2             # finite-difference order (options: 2, 4)

    [atmos_clim.janus]
        p_top           = 1.0e-6        # bar, top of atmosphere grid pressure
        p_obs           = 1.0e-3        # bar, observed pressure level
        spectral_group  = "Honeyside"   # which gas opacities to include
        spectral_bands  = "48"          # how many spectral bands?
        F_atm_bc        = 0             # measure outgoing flux at: (0) TOA | (1) Surface
        num_levels      = 40            # Number of atmospheric grid levels
        tropopause      = "none"        # none | skin | dynamic
        overlap_method    = "ee"        # gas overlap method

    [atmos_clim.dummy]
        gamma           = 0.01          # atmosphere opacity between 0 and 1
        height_factor   = 3.0           # observed height is this times the scale height

# Volatile escape - physics table
[escape]

    module     = "zephyrus"         # Which escape module to use
    reservoir  = "outgas"           # Reservoir that sets escaping gas composition

    [escape.zephyrus]
        Pxuv        = 5e-5          # Pressure at which XUV radiation become opaque in the planetary atmosphere [bar]
        efficiency  = 0.1           # Escape efficiency factor
        tidal       = false         # Tidal contribution enabled

    [escape.dummy]
        rate        = 0.0           # Bulk unfractionated escape rate [kg s-1]

# Interior - physics table
[interior]
    grain_size      = 0.1           # crystal settling grain size [m]
    F_initial       = 1e3           # Initial heat flux guess [W m-2]
    radiogenic_heat = false         # enable radiogenic heat production
    tidal_heat      = false         # enable tidal heat production
    rheo_phi_loc    = 0.6           # Centre of rheological transition
    rheo_phi_wid    = 0.2           # Width of rheological transition
    melting_dir     = "Monteux-600" # Name of folder constaining melting curves
    lookup_dir      = "1TPa-dK09-elec-free/MgSiO3_Wolf_Bower_2018_1TPa" # Name of folder with EOS tables, etc.


    module = "aragog"       # Which interior module to use

    [interior.spider]
        num_levels               = 100       # Number of SPIDER grid levels
        mixing_length            = 2         # Mixing length parameterization
        tolerance                = 1.0e-8    # absolute solver tolerance
        tolerance_rel            = 1.0e-8    # relative solver tolerance
        solver_type              = "bdf"     # SUNDIALS solver method
        tsurf_atol               = 20.0      # tsurf_poststep_change
        tsurf_rtol               = 0.02      # tsurf_poststep_change_frac
        ini_entropy              = 3000.0    # Surface entropy conditions [J K-1 kg-1]
        ini_dsdr                 = -4.698e-6 # Interior entropy gradient [J K-1 kg-1 m-1]
        conduction               = true      # enable conductive heat transfer
        convection               = true      # enable convective heat transfer
        gravitational_separation = true      # enable gravitational separation
        mixing                   = true      # enable mixing
        matprop_smooth_width     = 1e-2      # melt-fraction window width over which to smooth material properties

    [interior.aragog]
        logging                  = "ERROR"  # Aragog log verbosity
        num_levels               = 50       # Number of Aragog grid levels
        tolerance                = 1.0e-7   # solver tolerance
        initial_condition        = 3        # Initial T(p); 1: linear, 2: user defined, 3: adiabat
        ini_tmagma               = 3300.0   # Initial magma surface temperature [K]
        basal_temperature        = 7000.0   # CMB temperature when initial boundary = 1
        inner_boundary_condition = 1        # 1 = core cooling model, 2 = prescribed heat flux, 3 = prescribed temperature
        inner_boundary_value     = 4000     # core temperature [K], if inner_boundary_condition = 3. CMB heat flux [W/m^2], if if inner_boundary_condition = 2
        conduction               = true     # enable conductive heat transfer
        convection               = true     # enable convective heat transfer
        gravitational_separation = false    # enable gravitational separation
        mixing                   = false    # enable mixing
        dilatation               = false    # enable dilatation source term
        mass_coordinates         = false    # enable mass coordinates
        tsurf_poststep_change    = 30       # threshold of maximum change on surface temperature
        event_triggering         = true     # enable events triggering to avoid abrupt jumps in surface temperature
        bulk_modulus             = 260e9    # Adiabatic bulk modulus AW-EOS parameter [Pa].

    [interior.dummy]
        ini_tmagma  = 3300.0    # Initial magma surface temperature [K]
        tmagma_atol = 30.0      # Max absolute Tsurf change in each step
        tmagma_rtol = 0.05      # Max relative Tsurf change in each step
        mantle_tliq = 2700.0    # Liquidus temperature
        mantle_tsol = 1700.0    # Solidus temperature
        mantle_rho  = 4550.0    # Mantle density [kg m-3]
        mantle_cp   = 1792.0    # Mantle heat capacity [J K-1 kg-1]
        H_ratio     = 0.0       # Radiogenic heating [W/kg]

# Outgassing - physics table
[outgas]
    fO2_shift_IW    = 4         # atmosphere/interior boundary oxidation state [log10(Î”IW)]

    module = "calliope"         # Which outgassing module to use

    [outgas.calliope]
        include_H2O  = true     # Include H2O compound
        include_CO2  = true     # Include CO2 compound
        include_N2   = true     # Include N2 compound
        include_S2   = true     # Include S2 compound
        include_SO2  = true     # Include SO2 compound
        include_H2S  = true     # Include H2S compound
        include_NH3  = true     # Include NH3 compound
        include_H2   = true     # Include H2 compound
        include_CH4  = true     # Include CH4 compound
        include_CO   = true     # Include CO compound
        T_floor      = 700.0    # Temperature floor applied to outgassing calculation [K].
        rtol         = 0.0001   # Relative mass tolerance
        xtol         = 1e-06    # Absolute mass tolerance
        solubility   = true     # Enable solubility?

    [outgas.atmodeller]
        some_parameter = "some_value"

# Volatile delivery - physics table
[delivery]

    # Radionuclide parameters
    radio_tref = 4.55   # Reference age for concentrations [Gyr]
    radio_K    = 310.0  # ppmw of potassium (all isotopes)
    radio_U    = 0.031  # ppmw of uranium (all isotopes)
    radio_Th   = 0.124  # ppmw of thorium (all isotopes)

    # Which initial inventory to use?
    initial = 'elements'        # 'elements' | 'volatiles'

    # No module for accretion as of yet
    module = "none"

    # Set initial volatile inventory by planetary element abundances if [initial = 'elements']
    [delivery.elements]
        use_metallicity = false	 # whether or not to specify the elemental abundances in terms of solar metallicity
        metallicity = 1000	 # metallicity relative to solar metallicity

        H_oceans    = 5.0       # Hydrogen inventory in units of equivalent Earth oceans
        # H_ppmw      = 109.0     # Hydrogen inventory in ppmw relative to mantle mass
        # H_kg       = 1e20       # Hydrogen inventory in kg

        CH_ratio    = 1.0       # C/H mass ratio in mantle/atmosphere system
        # C_ppmw     = 0.0        # Carbon inventory in ppmw relative to mantle mass
        # C_kg       = 1e20       # Carbon inventory in kg

        NH_ratio    = 0.5       # N/H mass ratio in mantle/atmosphere system
        # N_ppmw      = 0.5       # Nitrogen inventory in ppmw relative to mantle mass
        # N_kg       = 1e20       # Nitrogen inventory in kg

        SH_ratio    = 2.0       # S/H mass ratio in mantle/atmosphere system
        # S_ppmw      = 2.0       # Sulfur inventory in ppmw relative to mantle mass
        # S_kg       = 1e20       # Sulfur inventory in kg

    # Set initial volatile inventory by partial pressures in atmosphere if [initial = 'volatiles']
    [delivery.volatiles]
        H2O  = 20.0             # partial pressure of H2O
        CO2  = 30.0             # partial pressure of CO2
        N2   = 0.0              # etc.
        S2   = 0.0
        SO2  = 0.0
        H2S  = 0.0
        NH3  = 0.0
        H2   = 0.0
        CH4  = 0.0
        CO   = 0.0

# Atmospheric chemistry postprocessing
[atmos_chem]

    module  = "vulcan"          # Atmospheric chemistry module
    when    = "manually"        # When to run chemistry (manually, offline, online)

    # Physics flags
    photo_on        = true      # Enable photochemistry
    Kzz_on          = true      # Enable eddy diffusion
    Kzz_const       = "none"    # Constant eddy diffusion coefficient (none => use profile)
    moldiff_on      = true      # Enable molecular diffusion in the atmosphere
    updraft_const   = 0.0       # Set constant updraft velocity

    # Vulcan-specific atmospheric chemistry parameters
    [atmos_chem.vulcan]
        clip_fl     = 1e-20     # Floor on stellar spectrum [erg s-1 cm-2 nm-1]
        clip_vmr    = 1e-10     # Neglect species with vmr < clip_vmr
        make_funs   = true      # Generate reaction network functions
        ini_mix     = "profile" # Initial mixing ratios (profile, outgas)
        fix_surf    = false     # Fixed surface mixing ratios
        network     = "SNCHO"   # Class of chemical network to use (CHO, NCHO, SNCHO)
        save_frames = false      # Plot frames during iterations
        yconv_cri   = 0.05      # Convergence criterion, value of mixing ratios
        slope_cri   = 0.0001    # Convergence criterion, rate of change of mixing ratios

# Calculate simulated observations
[observe]

    # Module with which to calculate the synthetic observables
    synthesis = "none"

    [observe.platon]
        downsample = 8      # Factor to downsample opacities
        clip_vmr   = 1e-8   # Minimum VMR for a species to be included
