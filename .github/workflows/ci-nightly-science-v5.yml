name: CI - Nightly Science Validation (v5)

on:
  push:
    branches:
      - tl/test_ecosystem_v5
  workflow_dispatch:

permissions:
  contents: read
  packages: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: formingworlds/proteus

jobs:
  branch-nightly-coverage:
    name: Branch Nightly Coverage (Integration - v5)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: ghcr.io/formingworlds/proteus:tl-test_ecosystem_v5
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root

    steps:
      - name: Checkout branch code
        uses: actions/checkout@v4
        with:
          ref: tl/test_ecosystem_v5
          fetch-depth: 0

      - name: Overlay code onto container
        run: |
          echo "Copying code over container base..."
          rsync -av --exclude='SPIDER' --exclude='socrates' --exclude='petsc' --exclude='AGNI' . /opt/proteus/
          cd /opt/proteus
          git config --global --add safe.directory /opt/proteus
          # Set Julia depot to avoid disk space issues during test runtime
          export JULIA_DEPOT_PATH=/tmp/julia_depot
          mkdir -p /tmp/julia_depot
          pip install -e ".[develop]" --no-deps

      - name: Read full coverage threshold
        run: |
          cd /opt/proteus
          python - <<'PY' >> "$GITHUB_ENV"
          import pathlib
          import tomllib

          data = tomllib.loads(pathlib.Path("pyproject.toml").read_text())
          val = float(data["tool"]["coverage"]["report"]["fail_under"])
          print(f"FULL_COV_FAIL_UNDER={val}")
          PY

      - name: Download test data
        run: |
          cd /opt/proteus
          proteus get stellar

      - name: Free up disk space and configure Julia
        run: |
          # Clean up temp directory to free space for Julia compilation
          rm -rf /tmp/* 2>/dev/null || true
          # Recreate Julia depot in tmp with more space
          mkdir -p /tmp/julia_depot
          echo "JULIA_DEPOT_PATH=/tmp/julia_depot" >> $GITHUB_ENV
          # Check available space
          df -h /tmp

      - name: Run integration coverage (dummy + integration and not slow)
        run: |
          cd /opt/proteus
          coverage erase
          # Explicitly include dummy suite first
          pytest tests/integration/test_integration_dummy.py \
            -v --tb=short \
            --cov=proteus \
            --cov-fail-under=0 \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-report=html \
            --cov-config=pyproject.toml
          # Then full integration (excluding slow) and append coverage
          pytest tests/integration \
            -m "integration and not slow" \
            -v --tb=short \
            --cov=proteus \
            --cov-append \
            --cov-fail-under=0 \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-report=html \
            --cov-config=pyproject.toml

      - name: Generate coverage JSON
        run: |
          cd /opt/proteus
          coverage json -o coverage-branch-nightly.json || true

      - name: Upload coverage XML and HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: v5-branch-nightly-coverage
          path: |
            /opt/proteus/coverage.xml
            /opt/proteus/htmlcov/
            /opt/proteus/coverage-branch-nightly.json
          retention-days: 14
