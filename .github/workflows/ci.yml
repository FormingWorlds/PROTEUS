name: CI Tests for PROTEUS # Continuous Integration Tests for PROTEUS

# Trigger on pushes/PRs to main and dev branches, plus manual workflow_dispatch
# Aligned with existing tests.yaml structure for consistency
# Temporarily includes tl/test_ecosystem_v1 and v2 for testing
on:
  push:
    branches:
      - main
      - dev
      - tl/test_ecosystem_v1
      - tl/test_ecosystem_v2
  pull_request:
    branches:
      - main
      - dev
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  workflow_dispatch:

permissions:
  actions: write
  contents: write

jobs:
  test:
    # Test suite with matrix testing across Python versions and OS platforms
    # Provides comprehensive coverage and ensures cross-platform compatibility
    name: Run Coverage and Tests
    strategy:
      fail-fast: false  # Continue testing all matrix combinations even if one fails
      matrix:
        os: ['ubuntu-latest']
        python-version: ['3.13']
        # To re-enable Python 3.12 later, uncomment below:
        # python-version: ['3.12', '3.13']
        include:
          # Ubuntu-specific system dependencies for compiled extensions
          # netcdf: Required for data I/O operations
          # libssl-dev: Required for cryptographic operations
          - os: ubuntu-latest
            INSTALL_DEPS: sudo apt-get update; sudo apt-get install libnetcdff-dev netcdf-bin libssl-dev tree
            CC: gcc
            CXX: g++
            FC: gfortran
          # macOS lane temporarily disabled; re-enable when current fixes are verified
          # - os: macos-14
          #   INSTALL_DEPS: brew uninstall --force pkg-config;  rm -f /opt/homebrew/bin/pkg-config; rm -f /opt/homebrew/share/aclocal/pkg.m4; rm -f  /opt/homebrew/share/man/man1/pkg-config.1; brew install gfortran netcdf netcdf-fortran tree
          #   CC: gcc
          #   CXX: g++
          #   FC: gfortran

    env:
      FWL_DATA: ${{ github.workspace }}/fwl_data
      PROTEUS_DIR: ${{ github.workspace }}
      RAD_DIR: ${{ github.workspace }}/socrates
      AGNI_DIR: ${{ github.workspace }}/AGNI
      JULIA_NUM_THREADS: 1

    runs-on: ${{ matrix.os }}
    steps:

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        if: runner.os == 'Linux'
        with:
          tool-cache: false

      - name: Free Disk Space (MacOS)
        if: runner.os == 'macOS'
        run: |
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"


      # https://stackoverflow.com/a/65356209
      - name: Install system dependencies
        run: ${{ matrix.INSTALL_DEPS }}

      # MacOS only: create symbolic link for gfortran
      - name: Symlink gfortran
        if: runner.os == 'macOS'
        run: |
          if [ ! -L /opt/homebrew/bin/gfortran ]; then
            sudo ln -s /opt/homebrew/bin/gfortran-13 /opt/homebrew/bin/gfortran
          fi
          sudo ln -s /opt/homebrew/Cellar/gcc/12.*/lib/gcc/12/*.dylib /opt/homebrew/lib/ || true
          which gfortran

      # Setup Julia
      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1.11'

      - name: Cache Julia
        uses: julia-actions/cache@v2
        with:
          include-matrix: 'false'

      # Checkout PROTEUS
      - name: Checkout PROTEUS
        uses: actions/checkout@v6

      # Clone MORS and aragog repos (not submodules, but separate repos for testing)
      - name: Clone MORS and aragog for local testing
        run: |
          git clone https://github.com/FormingWorlds/MORS.git
          git clone https://github.com/FormingWorlds/aragog.git

      # Get Lovepy
      - name: Get Lovepy
        run: |
          ./tools/get_lovepy.sh

      # Get VULCAN
      - name: Get VULCAN
        run: |
          ./tools/get_vulcan.sh

      # Restore cached lookup-data for PROTEUS
      - name: Get FWL data from cache
        uses: actions/cache@v4
        id: cache-fwl-data
        with:
          path: ${{ env.FWL_DATA }}
          key: fwl-data-2

      # Setup Python using the version defined in the matrix
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      # Try to restore the Python environment from the cache
      - name: Restore Python environment from cache
        uses: actions/cache@v4
        id: cache-virtualenv
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ env.pythonLocation }}-${{ hashFiles('./pyproject.toml') }}

      - name: Install PROTEUS (repo only)
        run:
          python -m pip install -e .[develop]

      - name: Install local MORS and aragog packages (overriding PyPI versions)
        run: |
          python -m pip install -e ./MORS
          python -m pip install -e ./aragog

      # Restore SOCRATES binaries from cache if available
      # Uses weekly cache key to allow periodic refreshes while maintaining speed
      - name: Restore SOCRATES cache
        uses: actions/cache/restore@v4
        id: cache-socrates-restore
        with:
          path: socrates/
          key: socrates-bins-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            socrates-bins-${{ runner.os }}-

      # Restore AGNI Julia depot from cache if available
      - name: Restore AGNI cache
        uses: actions/cache/restore@v4
        id: cache-agni-restore
        with:
          path: |
            AGNI/
            ~/.julia/
          key: agni-depot-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            agni-depot-${{ runner.os }}-

      - name: Install all PROTEUS external repo dependencies via cli.py.
        run:
          proteus install-all --export-env

      # Get FWL data
      # - name: Get additional FWL data
      #   if: steps.cache-fwl-data.cache-hit != 'true'
      #   run: |
      #     proteus get stellar
      #     proteus get spectral --name Frostflow --bands 48

      # Run PROTEUS tests with coverage
      # Tests are organized in tests/ directory mirroring src/ folder structure
      # See: docs/testing_infrastructure.md for test organization guidelines
      # pytest configuration: pyproject.toml [tool.pytest.ini_options]
      - name: Test with pytest
        run: coverage run -m pytest

      # Record the content of the FWL_DATA folder
      - name: Record FWL data folder
        if: ${{ !cancelled() }}
        run: |
          CUR=$(pwd)
          cd $FWL_DATA
          tree
          echo $FWL_DATA > $CUR/output/FWL_DATA.txt
          tree >> $CUR/output/FWL_DATA.txt
          cd $CUR

      # Upload result if tests fail
      - name: Upload result on failure
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: proteus_output_folder
          path: output/

      # Save SOCRATES binaries for next run (only if not already cached)
      - name: Save SOCRATES cache
        if: steps.cache-socrates-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: socrates/
          key: socrates-bins-${{ runner.os }}-${{ github.run_id }}

      # Save AGNI installation for next run (only if not already cached)
      - name: Save AGNI cache
        if: steps.cache-agni-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            AGNI/
            ~/.julia/
          key: agni-depot-${{ runner.os }}-${{ github.run_id }}

      # Generate and report coverage metrics
      # Reports coverage as JSON, terminal output, and GitHub step summary
      # Coverage configuration: pyproject.toml [tool.coverage.report]
      - name: Report coverage
        if: ${{ !failure() }}
        run: |
          coverage json
          export TOTAL=$(python -c "import json;print(json.load(open('coverage.json'))['totals']['percent_covered_display'])")
          echo "Total coverage: $TOTAL"
          echo "total=$TOTAL" >> $GITHUB_ENV
          echo "### Total coverage: ${TOTAL}%" >> $GITHUB_STEP_SUMMARY
          echo $'\n```' >> $GITHUB_STEP_SUMMARY
          coverage report >> $GITHUB_STEP_SUMMARY
          echo $'\n```' >> $GITHUB_STEP_SUMMARY
          coverage report

      # Create dynamic coverage badge for documentation
      # Only runs on main branch with Python 3.13 to avoid redundant updates
      # Badge URL: stored in GitHub Gist for display in README
      - name: Make coverage badge
        if: ${{ github.ref == 'refs/heads/main' && matrix.python-version == '3.13' && runner.os == 'Linux' && !failure() }}
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: b4ee7dab92e20644bcb3a5ad09f71165
          filename: covbadge.svg
          label: Coverage
          message: ${{ env.total }}%
          minColorRange: 50
          maxColorRange: 90
          valColorRange: ${{ env.total }}
